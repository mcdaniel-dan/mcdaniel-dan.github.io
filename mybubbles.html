<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
		<title>Simple JS Physics</title>

		<script type="text/javascript" src="jquery-1.4.2.min.js"></script>

		<style>
			* { margin:0; padding:0; background-color:#333333; }
		</style>

		<canvas id="stage" width="400" height="400">
			<p>Your browser doesn't support canvas.</p>
		</canvas>

		<script type="text/javascript">

			var stage = document.getElementById('stage');
			var rack = ""; //to store letters for word making

			var browserX = window.screenX;
			var browserY = window.screenY;
			var balls = [];
			var volleySize = 1; //number of balls generated
			var maxBalls = 10;
			var currentDrag = null;
			var mouseX = 0;
			var mouseY = 0;

			//var stageWidth = $(document).width();   //jQuery
			var stageWidth = getDocWidth();           //Pure JS

			//var stageHeight = $(document).height(); //jQuert
      var stageHeight = getDocHeight();					//Pure JS

			stage.width = stageWidth;
			stage.height = stageHeight;

			document.addEventListener(Event.MOUSEMOVE, getMouseXY, false);
			document.onmousemove = getMouseXY;

			window.onresize = function(event) {
				stage.width = 10;
				stage.height = 10;
				stageWidth = $(document).width();
				stageHeight = $(document).height();
				stage.width = stageWidth;
				stage.height = stageHeight;
			}

			generateBalls(0,0);

			var drawingCanvas = document.getElementById('stage');
			if(drawingCanvas.getContext) {
				var context = drawingCanvas.getContext('2d');
				setInterval(render, 20);
			}

      //Todo: Convert to Pure JS
			jQuery(document).ready(function()
			{
				//Pure JS
				stage.onmousedown  = function (e) { onMouseDown(); }
        stage.onmouseup    = function (e) { onMouseUp();   }
				stage.ontouchstart = function (e) { onMouseDown(); }
				stage.ontouchend   = function (e) { onMouseUp();   }
			})

      //todo: handle clicking on words
			function onMouseDown() {
				// var dx = mouseX - rack.x;
				// var dy = mouseY - rack.y;

				var j = balls.length; //array of balls
				while(--j > -1) {
					var dx = mouseX - balls[j].x;
					var dy = mouseY - balls[j].y;
					var dist = Math.sqrt(dx * dx + dy * dy);
					if(dist < balls[j].size/2) {
						currentDrag = balls[j];
						currentDrag.dragging = true;
						rack += currentDrag.letter; //add letter to rack
						balls.splice(j,1); //remove from balls
						return;
					}
				}
				generateBalls(mouseX, mouseY);
			}

			function onMouseUp() {
				if(currentDrag != null) currentDrag.dragging = false;
			}

			function generateBalls(mX, mY) {
				if (balls.length < maxBalls) {
					for(var i = 0; i < volleySize; i++)	{
						var ball = {}; //ball object
						ball.letter = generateLetter();
						ball.color = generateColor();
						ball.bounce = .5 + (Math.random() * .5);
						ball.vx = Math.random() * 50 - 25;
						ball.vy = Math.random() * 50 - 25;
						//ball.size = 45 - (ball.bounce * 25); //original size
						ball.size = 30; //fixed ball size

						ball.x = Math.random() * stageWidth;
						ball.y = Math.random() * stageHeight;
						//					 ball.x = (mX) ? (mX + Math.random() * 4) : (Math.random() * stageWidth);
						//					 ball.y = (mY) ? (mY + Math.random() * 4) : (Math.random() * stageHeight);
						balls[balls.length] = ball;
					}
				}
			}

			//generates random color
			function generateColor()
			{
				color="#"
				for (i = 0; i < 6; i++) {
					color += "0123456789abcdef".charAt(Math.round(Math.random()*16));
				}
  		  return color;
				//return "red";
			}

			//generates random color
			function generateLetter() {
				return "aaaaaaaabcccddddeeeeeeeeeeeeeffgghhhhhhiiiiiiijkllllmmnnnnnnnooooooooppqrrrrrrsssssstttttttttuuuvwwxyyz".charAt(Math.round(Math.random()*103));
			}

			function render() {
				var isChange = (browserX != window.screenX || browserY != window.screenY);
				if(isChange) {
					var diffX = browserX - window.screenX;
					browserX = window.screenX;

					var diffY = browserY - window.screenY;
					browserY = window.screenY;
				}

				var j = balls.length;
				while(--j > -1) {
					update(balls[j]);

					if(isChange) {
						balls[j].vx += (diffX * .05);
						balls[j].vy += (diffY * .1);
					}
				}

				draw();
			}

			function draw() {
				generateBalls();
				context.clearRect(0, 0, stageWidth, stageHeight);
        context.font = "30px Verdana";
				var i = balls.length;
				while(--i > -1) {
					//Letter
					context.fillStyle = "white";
					context.textAlign="center";
					context.zIndex = 5;
					context.fillText(balls[i].letter, balls[i].x, balls[i].y + 9);


					//Ball
					context.fillStyle = balls[i].color;
					context.beginPath();
					context.arc(balls[i].x,balls[i].y,balls[i].size,0,Math.PI*2,true);
					context.closePath();
					context.zIndex = -1;
					context.fill();

					// Create gradient
					// var gradient = context.createLinearGradient(0, 0, stageWidth, 0);
					// gradient.addColorStop("0", "magenta");
					// gradient.addColorStop("0.5", "blue");
					// gradient.addColorStop("1.0", "red");
					// Fill with gradient
					//context.fillStyle = gradient;
					//context.fillText("Big smile!", 10, 90);


				}
				//write the letter rack
				context.fillText(rack, stageWidth / 2, stageHeight - 20);
			}

			function update(ball) {
				collisionCheck();

				// var gravity = 0.25; //original gravity
				// var drag = .98; //original drag

				var gravity = 0;
				var drag = .9999999;

				if(ball.dragging) {
					ball.vx = ball.x - ball.ox;
					ball.vy = ball.y - ball.oy;
					ball.ox = ball.x;
					ball.oy = ball.y;

					ball.x = mouseX;
					ball.y = mouseY;

					if ((ball.x + ball.size) > stageWidth) {
						ball.x = stageWidth - ball.size;
					} else if((ball.x - ball.size) < 0) {
						ball.x = 0 + ball.size;
					}

					if ((ball.y + ball.size) > stageHeight) {
						ball.y = stageHeight - ball.size;
					} else if((ball.y - ball.size) < 0) {
						ball.y = 0 + ball.size;
					}
				} else {
					ball.x += ball.vx;
					ball.y += ball.vy;

					if ((ball.x + ball.size) > stageWidth) {
						ball.x = stageWidth - ball.size;
						ball.vx = -ball.vx * ball.bounce;
					}
					else if((ball.x - ball.size) < 0) {
						ball.x = 0 + ball.size;
						ball.vx = -ball.vx * ball.bounce;
					}

					if ((ball.y + ball.size) > stageHeight) {
						ball.y = stageHeight - ball.size;
						ball.vy = -ball.vy * ball.bounce;
					}
					else if((ball.y - ball.size) < 0) {
						ball.y = 0 + ball.size;
						ball.vy = -ball.vy * ball.bounce;
					}

					ball.vx = ball.vx * drag;
					ball.vy = ball.vy * drag + gravity;
				}
			}

      //todo: code stickyness
			function collisionCheck()
			{
				var spring = .5;

				for(var i = 0; i < (balls.length-1); ++i)
				{
					var ball0 = balls[i];

					for(var j = i + 1; j < balls.length; ++j)
					{
						var ball1 = balls[j];
						var dx = ball1.x - ball0.x;
						var dy = ball1.y - ball0.y;
						var dist = Math.sqrt(dx * dx + dy * dy);
						var minDist = ball0.size + ball1.size;

						if(dist < minDist) {
							var angle = Math.atan2(dy, dx);
							var tx = ball0.x + dx / dist * minDist;
							var ty = ball0.y + dy / dist * minDist;
							var ax = (tx - ball1.x);
							var ay = (ty - ball1.y);


							ball0.x -= ax;
							ball0.y -= ay;

							ball1.x += ax;
							ball1.y += ay;


							ball0.vx -= (ax * spring);
							ball0.vy -= (ay * spring);
							ball1.vx += (ax * spring);
							ball1.vy += (ay * spring);
						}
					}
				}
			}

			function getMouseXY(e) {
  				mouseX = e.pageX;
  				mouseY = e.pageY;

  				if (mouseX < 0) { mouseX = 0; }
  				if (mouseY < 0) { mouseY = 0; }

  				return true;
			}

			function getDocWidth() {
				var w = window;
				d = document;
				e = d.documentElement;
				b = d.getElementsByTagName('body')[0];
				x = w.innerWidth || e.clientWidth || b.clientWidth;
				return x;
			}

			function getDocHeight() {
				var w = window;
				d = document;
				e = d.documentElement;
				b = d.getElementsByTagName('body')[0];
				y = w.innerHeight || e.clientHeight || b.clientHeight;
				return y;
			}

		</script>

	</head>
</html>
